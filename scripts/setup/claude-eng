#!/bin/bash
# Claude CLI wrapper with engineering best practices system prompt
# Enables YOLO mode for fully autonomous operation
#
# This script:
# 1. Bypasses all permissions for unattended operation
# 2. Injects custom system prompts with engineering best practices
# 3. Enables all tools for maximum capability
# 4. Provides consistent command across different machines

set -e

# Enable verbose mode with --verbose flag
VERBOSE=false
if [[ "$*" == *"--verbose"* ]]; then
    VERBOSE=true
    # Remove --verbose from args to pass to claude
    set -- "${@/--verbose/}"
fi

# Default to Sonnet model for quality research (can override with CLAUDE_MODEL env var)
# Sonnet 4.5: $3/$15 per million tokens - optimal balance of quality and cost
# Alternative models:
#   - Haiku 3.5: $0.80/$4 per million (fastest, cheapest, lower quality)
#   - Opus 4.1: $15/$75 per million (highest quality, slowest, most expensive)
CLAUDE_MODEL="${CLAUDE_MODEL:-sonnet}"

# Find the system prompt file
# SCRIPT_DIR can be overridden for testing
if [ -z "$SCRIPT_DIR" ]; then
  SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"
fi

SYSTEM_PROMPT_FILE="${SCRIPT_DIR}/.claude-system-prompt.md"

if [ ! -f "$SYSTEM_PROMPT_FILE" ]; then
    echo "Error: System prompt file not found at $SYSTEM_PROMPT_FILE" >&2
    exit 1
fi

# Find claude executable
# Allow PATH override for testing
CLAUDE_EXEC="${CLAUDE_EXEC:-}"
if [ -z "$CLAUDE_EXEC" ]; then
  if [ -x "$HOME/.claude/local/claude" ]; then
    CLAUDE_EXEC="$HOME/.claude/local/claude"
  elif command -v claude &> /dev/null; then
    CLAUDE_EXEC="claude"
  else
    echo "Error: Claude CLI not found. Install from https://docs.claude.com" >&2
    exit 1
  fi
fi

if [ "$VERBOSE" = true ]; then
    echo "Claude Engineering Mode"
    echo "  Model: $CLAUDE_MODEL"
    echo "  System prompt: $SYSTEM_PROMPT_FILE"
    echo "  Claude CLI: $CLAUDE_EXEC"
    echo ""
fi

# Find the stream-json parser
PARSER_SCRIPT="${SCRIPT_DIR}/../stream-json-parser.sh"
if [ ! -x "$PARSER_SCRIPT" ]; then
    PARSER_SCRIPT="$(dirname "$SCRIPT_DIR")/stream-json-parser.sh"
fi

# Use stream-json with parser for structured progress display
# --verbose is required for stream-json with -p mode
if [ -x "$PARSER_SCRIPT" ] && command -v jq &> /dev/null; then
    exec "$CLAUDE_EXEC" --append-system-prompt "$(cat "$SYSTEM_PROMPT_FILE")" \
        --model "$CLAUDE_MODEL" \
        --allowedTools "*" \
        --dangerously-skip-permissions \
        --permission-mode "bypassPermissions" \
        --output-format stream-json \
        --verbose \
        "$@" 2>&1 | "$PARSER_SCRIPT"
else
    # Fallback: plain text output (no parser/jq available)
    exec "$CLAUDE_EXEC" --append-system-prompt "$(cat "$SYSTEM_PROMPT_FILE")" \
        --model "$CLAUDE_MODEL" \
        --allowedTools "*" \
        --dangerously-skip-permissions \
        --permission-mode "bypassPermissions" \
        "$@"
fi
